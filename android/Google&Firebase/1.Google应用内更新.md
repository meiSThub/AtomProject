

# 一、Google应用内升级

海外应用，不可避免的会使用到 **Google Play** 提供的应用内升级功能，不用跳转到GP进行应用的升级，体验更好。

官方接入文档：

* [应用内更新(概述)](https://developer.android.com/guide/playcore/in-app-updates?hl=zh-cn)
* 接入步骤参考：[支持应用内更新（Kotlin 或 Java）](https://developer.android.com/guide/playcore/in-app-updates/kotlin-java?hl=zh-cn)

## 1、集成 Play 应用内更新库

```groovy
// In your app’s build.gradle file:
...
dependencies {
    // This dependency is downloaded from the Google’s Maven repository.
    // So, make sure you also include that repository in your project's build.gradle file.
    implementation 'com.google.android.play:app-update:2.0.1'

    // For Kotlin users also add the Kotlin extensions library for Play In-App Update:
    implementation 'com.google.android.play:app-update-ktx:2.0.1'
    ...
}
```

## 2、检查是否有可用更新

```kotlin
// 创建一个AppUpdateManager对象，用于检测更新和执行更新操作
val appUpdateManager = AppUpdateManagerFactory.create(context)

// Returns an intent object that you use to check for an update.
val appUpdateInfoTask = appUpdateManager.appUpdateInfo

appUpdateInfoTask.addOnSuccessListener { appUpdateInfo: AppUpdateInfo ->
            // 有更新
            if (appUpdateInfo.updateAvailability() == UpdateAvailability.UPDATE_AVAILABLE) {
                // 立即更新
                if (appUpdateInfo.isUpdateTypeAllowed(AppUpdateType.IMMEDIATE)) {
                    appUpdateManager.startUpdateFlowForResult(appUpdateInfo, AppUpdateType.IMMEDIATE, activity, UPDATE_REQUEST_CODE)
                } else if (appUpdateInfo.isUpdateTypeAllowed(AppUpdateType.FLEXIBLE)) {
                    // 灵活更新
                    appUpdateManager.startUpdateFlowForResult(appUpdateInfo, AppUpdateType.FLEXIBLE, activity, UPDATE_REQUEST_CODE)
                }
            }
        }
```

通过 addOnSuccessListener 方法，返回的 AppUpdateInfo 信息，可用于启动更新，且只可以使用一次，不可以重复只用。但可以通过重复调用 addOnSuccessListener 方法来实现获取一个新的 AppUpdateInfo 对象。

## 3、启动更新

在确认有可用更新后，您可以使用 [`AppUpdateManager.startUpdateFlowForResult()`](https://developer.android.com/reference/com/google/android/play/core/appupdate/AppUpdateManager?hl=zh-cn#startupdateflowforresult) 启动更新：

```kotlin
appUpdateManager.startUpdateFlowForResult(
    // Pass the intent that is returned by 'getAppUpdateInfo()'.
    appUpdateInfo,
    // Or 'AppUpdateType.FLEXIBLE' for flexible updates.
    AppUpdateType.IMMEDIATE,
    // The current activity making the update request.
    this,
    // Include a request code to later monitor this update request.
    MY_REQUEST_CODE)
```

如果是 AppUpdateType.IMMEDIATE（立即更新），则会显示一个更新的界面，覆盖在App的上面；

如果是 AppUpdateType.FLEXIBLE（灵活更新），则会在通知中显示一个下载进度任务。

## 4、处理立即更新

在您启动立即更新且用户同意开始更新后，Google Play 会在整个更新期间在应用界面顶部显示更新进度。如果用户在更新期间关闭或终止您的应用，更新应继续在后台下载并安装，无需额外得到用户确认。

不过，当您的应用返回到前台时，您应确认更新未在 [`UpdateAvailability.DEVELOPER_TRIGGERED_UPDATE_IN_PROGRESS`](https://developer.android.com/reference/com/google/android/play/core/install/model/UpdateAvailability?hl=zh-cn#DEVELOPER_TRIGGERED_UPDATE_IN_PROGRESS) 状态下停止。如果更新在此状态下停止，请继续更新：

```kotlin
// Checks that the update is not stalled during 'onResume()'.
// However, you should execute this check at all entry points into the app.
override fun onResume() {
    super.onResume()

    appUpdateManager
        .appUpdateInfo
        .addOnSuccessListener { appUpdateInfo ->
            ...
            if (appUpdateInfo.updateAvailability()
                == UpdateAvailability.DEVELOPER_TRIGGERED_UPDATE_IN_PROGRESS
            ) {
                // If an in-app update is already running, resume the update.
                appUpdateManager.startUpdateFlowForResult(
                    appUpdateInfo,
                    AppUpdateType.IMMEDIATE,
                    this,
                    MY_REQUEST_CODE
                )
            }
        }
}
```

## 5、处理灵活更新

在检测到 `InstallStatus.DOWNLOADED` 状态时，您需要重启应用以安装更新。

与立即更新不同，Google Play 不会为灵活更新自动触发应用重启。这是因为，在灵活更新期间，用户希望在他们决定想要安装更新之前能够继续与应用互动。

建议您提供通知（或其他一些界面指示）以告知用户更新已可供安装，并在重启应用之前请求用户确认。

```kotlin
val listener = { state ->
    if (state.installStatus() == InstallStatus.DOWNLOADED) {
        // After the update is downloaded, show a notification
        // and request user confirmation to restart the app.
        popupSnackbarForCompleteUpdate()
    }
    ...
}

// Displays the snackbar notification and call to action.
fun popupSnackbarForCompleteUpdate() {
    Snackbar.make(
        findViewById(R.id.activity_main_layout),
        "An update has just been downloaded.",
        Snackbar.LENGTH_INDEFINITE
    ).apply {
        setAction("RESTART") { appUpdateManager.completeUpdate() }
        setActionTextColor(resources.getColor(R.color.snackbar_action_text_color))
        show()
    }
}
```

通过一个弹框，提醒用户可以更新已经完成，可以重启应用了，也可以不用弹框，直接重启。



# 二、强制更新

虽然 Google Play 提供了两种更新方式：灵活更新 和 立即更新 ，那什么时候使用立即更新，什么时候使用 灵活更新 呢？这个时候可以有两种方式可以做的：

* 根据 updatePriority （更新优先级）：来判断进行哪种更新方式。

  Google Play 使用 0 到 5 之间的整数值来确定优先级，其中 0 是默认值，5 代表最高优先级。如需设置更新的优先级，请使用 Google Play Developer API 中 `Edits.tracks.releases` 下的 `inAppUpdatePriority` 字段。发布版本中的所有新增版本都被视为与发布版本具有相同的优先级。只有在发布新版本时才能设置优先级，且以后无法更改。

  根据 [Play Developer API 文档](https://developers.google.com/android-publisher/tracks?hl=zh-cn#apk_workflow_example)中的描述，使用 Google Play Developer API 设置优先级。应用内更新优先级应在 [`Edit.tracks: update`](https://developers.google.com/android-publisher/api-ref/rest/v3/edits.tracks/update?hl=zh-cn) 方法中传递的 [`Edit.tracks`](https://developers.google.com/android-publisher/api-ref/rest/v3/edits.tracks?hl=zh-cn) 资源中指定。以下示例演示了如何发布一个版本代码为 88 且 `inAppUpdatePriority` 为 5 的应用：

  ```json
  {
    "releases": [{
        "versionCodes": ["88"],
        "inAppUpdatePriority": 5,
        "status": "completed"
    }]
  }
  ```

​		需要后台通过 Google Play Developer API  接口来设置。比较麻烦。

* 通过 Firebase Remote Config（Firebase 远程配置）实现。相对方便。如在App的 Firebase 的控制台中，添加控制参数：

  接入文档：[Firebase远程配置](https://firebase.google.com/docs/remote-config/get-started?platform=android&authuser=0)

  ![image-20221123144118107](https://raw.githubusercontent.com/meiSThub/BlogImage/master/2022image-20221123144118107.png)

​		通过参数控制，当前版本是否需要进行强制更新，比如配置参数为：updateVersionCode=200，则App 版本号 小于 200 的，就需要进行强制更新，版本号 大于 200，但小于最新版本的App，则进行 灵活更新。

不管是使用 更新优先级 还是 使用 Firebase远程配置 ，只要确定了当前版本需要使用强制更新，则在 启动更新的时候，就使用  AppUpdateType.IMMEDIATE（立即更新） 模式来更新App。

虽然这种模式用户也可以取消更新，但我们可以在 onActivityResult 方法中，监听更新的返回结果。

```kotlin
fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
    if (requestCode == UPDATE_REQUEST_CODE) {
        if (resultCode != RESULT_OK) {
            Log.e("MY_APP", "Update flow failed! Result code: $resultCode")
            // If the update is cancelled or fails,
            // you can request to start the update again.
            // 如果用户取消了更新，但又需要进行强制更新的时候，可以再次启动更新，否则无法使用App
            appUpdateManager.appUpdateInfo.addOnSuccessListener { appUpdateInfo ->
                // 有更新
                if (appUpdateInfo.updateAvailability() == UpdateAvailability.UPDATE_AVAILABLE) {
                    // 立即更新
                    if (appUpdateInfo.isUpdateTypeAllowed(AppUpdateType.IMMEDIATE)) {
                        appUpdateManager.startUpdateFlowForResult(appUpdateInfo, AppUpdateType.IMMEDIATE, activity, UPDATE_REQUEST_CODE)
                    } else if (appUpdateInfo.isUpdateTypeAllowed(AppUpdateType.FLEXIBLE)) {
                        // 灵活更新
                        appUpdateManager.startUpdateFlowForResult(appUpdateInfo, AppUpdateType.FLEXIBLE, activity, UPDATE_REQUEST_CODE)
                    }
                }
            }
        }
    }
}
```

# 三、应用内升级测试

更新测试流程：

* 打一个高版本的测试包，上传到内部测试渠道

  ![image-20221123145129362](https://raw.githubusercontent.com/meiSThub/BlogImage/master/2022image-20221123145129362.png)

* 添加测试用GP账号到白名单，及添加内部测试账号
* 安装低版本App，看是否检测到更新。这个过程会比较慢，有可能很久都检测不到更新。



### 注意事项

- 你的手机上，你的GP账号应该要至少下载过一次App。

- 如果总是刷不到最新版本信息，那么Kill 掉GP，重新启动试试，确保GP缓存失效。

- 调试用的版本号一定要低于GP线上版本号，主要是VersionCode。

- 本地包可以调试下载更新过程。

- GP刷出新版本，通常需要几个小时的时间，30分钟算是很快的了，而且就算刷到最新版本信息，还不一定能进行更新（这可能是GP的BUG）。为了能快速刷出新版本信息，可以在GP后台**发布内测版本**，添加测试用GP账号到白名单。内测版本发布后，白名单内测用户在几秒钟可以刷到最新信息。

- 可以通过  [内部分享渠道](https://play.google.com/console/u/0/internal-app-sharing/)，分享内部测试App，如：

  ![image-20221123105807069](https://raw.githubusercontent.com/meiSThub/BlogImage/master/2022image-20221123105807069.png)

# 参考：

* [Android 应用内更新 Support in-app updates [GP官方支持]](https://juejin.cn/post/6844903846448398343)