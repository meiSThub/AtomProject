### 1、Android平台虚拟机是基于栈的吗？

解析：

Android平台的虚拟机主要有两种：

* Dalvik
* ART

基于栈的虚拟机：基于哪个栈，操作数栈，还是虚拟机栈？

基于栈和基于寄存器的区别？

运行时栈帧：

虚拟机栈：记录线程内方法的执行状态

栈帧：栈中的元素，对应每一个方法的执行情况。包含有：

* （1）局部变量表
* （2）操作数栈
* （3）方法出口：该方法需要返回给谁，返回值是多少。

#### 1-1、基于栈的虚拟机

方法的执行过程：

```kotlin
fun main(){
	foo()
}

fun foo(){
	val a=1
	val b=2
	val c=(a+b)*9
}
```

![image-20220913153738567](https://raw.githubusercontent.com/meiSThub/BlogImage/master/2022image-20220913153738567.png)

* （1）第0行：执行第一行字节码，把常量1推送到栈顶，此时程序计数器记录第0行

* （2）第一行：将操作数栈 栈顶到Int型数据存入第一个本地变量a，并出栈。程序计数器指向：1

* （3）第二行：将一个int型的常量 2 推送到操作数栈栈顶

* （4）第三行：将栈顶的int型数据存入 第二个本地变量b，并出栈。

  这样就完成了 变量a 和 b的赋值。

* （5）第四行：把局部变量表中的第一个变量，加载到操作数栈中

* （6）第五行：把局部变量表中的第二个变量，加载到操作数栈中

* （7）第六行：把操作数栈栈顶的两个元素进行相加操作，并把结果推送到栈顶

* （8）第七行：把常量9压入栈顶

* （9）第九行：将栈顶到两个元素相乘，并把结果压入栈顶，栈顶到数值就是27

* （10）第a行：将栈顶的元素存入本地变量c

* （11）第b行：将结果返回



#### 1-2、基于寄存器的虚拟机

Dalvik虚拟机：

![image-20220913164238728](https://raw.githubusercontent.com/meiSThub/BlogImage/master/2022image-20220913164238728.png)

* （1）第0行：将给定字面量 1 移动到指定寄存器v0中
* （2）第1行：将 2 保存到寄存器v1中
* （3）第2行：将两个寄存器的值进行相加，并把结果保存到寄存器v0中
* （4）第3行：将寄存器v0 和 给定的字面量 9 进行相乘运算，并把结果存储在寄存器v0中，即c 的值。
* （5）第4行：方法返回，并返回结果。

最终结果：

![image-20220913165720208](https://raw.githubusercontent.com/meiSThub/BlogImage/master/2022image-20220913165720208.png)

编译优化：以使用最少寄存器为前提，不改变语义，优化掉无用代码。

![image-20220913170100040](https://raw.githubusercontent.com/meiSThub/BlogImage/master/2022image-20220913170100040.png)

#### 1-3、如何看待基于栈的虚拟机设计?

1、JVM基于栈去设计的初衷之一，是压缩代码体积。

* Java设计之初最重要的一个特性就是跨平台,支持嵌入式设备和手持设备(J2ME)。
* Java设计之初,另一个特性是,支持远程传输执行字节码,要降低传输开销。

2、基于栈的虚拟机,字节码实现简单。

* 指的是生成字节码的过程简单,而不是虚拟机本身简单,或者说是编译器的实现简单。
* 操作时,不用考虑寄存器的地址(绝对位置) , 只需要把想要操作的数据出栈、入栈,然后再实现如何针对栈进行操作就可以了。

3、基于栈的虚拟机，可移植性高。

* 为了提高效率,虚拟寄存器要映射到真实机器的寄存器,增加移植难度。
* 代码移植到其他硬件平台的时候,不用考了真实机器寄存器的差异，因为操作栈的指令是通用的。



#### 1-4、如何看待Android平台基于寄存器的设计?

1、更快!更省内存!

* 指令条数少
* 数据移动次数少、临时结果存放次数少
* 映射真实机器的寄存器
* 因为操作栈的指令是通用


2、Android不需要解决移植性问题

* Android平台的操作系统是统一，所以不存在移植性问题

3、用其他方式解决了代码体积问题

*  dex文件优化

因此，Android 平台采用了基于寄存器的虚拟机实现。



## 2、为什么dex 文件比 class 文件更适合移动端

